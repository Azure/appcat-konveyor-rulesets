name: Local CI

on: ["push", "pull_request"]

jobs:
  test:
    runs-on: windows-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3

      - name: Check environment
        shell: pwsh
        run: |
          Write-Host "=== Java version ==="
          java -version 2>&1
          Write-Host ""
          Write-Host "=== Maven version ==="
          mvn -version 2>&1
          Write-Host ""
          Write-Host "=== Test files count ==="
          $testFiles = Get-ChildItem -Path ".\default\generated\" -Recurse -Filter "*.test.yaml"
          Write-Host "Total .test.yaml files: $($testFiles.Count)"

      - name: Run appcat test
        id: appcat-test
        shell: pwsh
        continue-on-error: true
        run: |
          Invoke-WebRequest -Uri "https://aka.ms/appcat/azure-migrate-appcat-for-java-cli-windows-amd64.zip" -OutFile "appcat.zip"
          Expand-Archive -Path "appcat.zip" -DestinationPath "."
          $appcatDir = Get-ChildItem -Directory -Filter "azure-migrate-appcat-for-java-cli-*" | Select-Object -First 1
          & "$($appcatDir.FullName)\appcat.exe" test .\default\generated\ 2>&1 | Tee-Object -FilePath "output.log"
          $content = Get-Content "output.log" -Tail 5
          $content | Out-File -FilePath "message.md"
          $msg = ($content | Select-String -Pattern "Rules Summary:" -Context 0,1) -join "`n"
          $tests_pass_rate = ($content | Select-String -Pattern "Rules Summary:" | ForEach-Object { $_ -replace '.*Rules Summary:\s*', '' -replace '.*:', '' })
          $tcs_pass_rate = ($content | Select-String -Pattern "Test Cases Summary:" | ForEach-Object { $_ -replace '.*Test Cases Summary:\s*', '' -replace '.*:', '' })
          
          "msg<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $msg | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          "tcs_pass_rate<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $tcs_pass_rate | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          "tests_pass_rate<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $tests_pass_rate | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Comment on the PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = `${{ steps.appcat-test.outputs.msg }}`;

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number
            });

            const botComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]');
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true

      - name: Update tests badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tests-rate
          LABEL: Test Status
          STATUS: ${{ steps.appcat-test.outputs.tests_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update test case badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tcs-rate
          LABEL: Test Case Status
          STATUS: ${{ steps.appcat-test.outputs.tcs_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check test result
        if: ${{ steps.appcat-test.outcome == 'failure' }}
        run: exit 1