name: Local CI

on: ["push", "pull_request"]

jobs:
  test:
    runs-on: windows-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3

      - name: Check environment
        shell: pwsh
        run: |
          Write-Host "=== Java version ==="
          java -version 2>&1
          Write-Host ""
          Write-Host "=== Maven version ==="
          mvn -version 2>&1
          Write-Host ""
          Write-Host "=== Test files count ==="
          $testFiles = Get-ChildItem -Path ".\default\generated\" -Recurse -Filter "*.test.yaml"
          Write-Host "Total .test.yaml files: $($testFiles.Count)"

      - name: Run appcat test
        id: appcat-test
        shell: pwsh
        continue-on-error: true
        run: |
          Invoke-WebRequest -Uri "https://aka.ms/appcat/azure-migrate-appcat-for-java-cli-windows-amd64.zip" -OutFile "appcat.zip"
          Expand-Archive -Path "appcat.zip" -DestinationPath "."
          $appcatDir = Get-ChildItem -Directory -Filter "azure-migrate-appcat-for-java-cli-*" | Select-Object -First 1
          & "$($appcatDir.FullName)\appcat.exe" test .\default\generated\azure\tests\07-azure-message-queue.test.yaml 2>&1 | Tee-Object -FilePath "output.log"
          
          $content = Get-Content "output.log" -Raw
          
          # Extract Rules Summary line
          $rulesLine = ($content | Select-String -Pattern "Rules Summary:.*PASSED" -AllMatches).Matches.Value
          # Extract Test Cases Summary line  
          $tcsLine = ($content | Select-String -Pattern "Test Cases Summary:.*PASSED" -AllMatches).Matches.Value
          
          # Build message
          $msg = @"
          $rulesLine
          $tcsLine
          "@
          
          # Extract pass rates (e.g., "722/742 (97.30%) PASSED")
          $tests_pass_rate = if ($rulesLine -match '(\d+/\d+ \(\d+\.\d+%\) PASSED)') { $Matches[1] } else { "N/A" }
          $tcs_pass_rate = if ($tcsLine -match '(\d+/\d+ \(\d+\.\d+%\) PASSED)') { $Matches[1] } else { "N/A" }
          
          Write-Host "=== Extracted Summary ==="
          Write-Host "Rules: $rulesLine"
          Write-Host "Test Cases: $tcsLine"
          
          "msg<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $msg | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          "tcs_pass_rate<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $tcs_pass_rate | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

          "tests_pass_rate<<EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          $tests_pass_rate | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "EOF" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Comment on the PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v6
        with:
          script: |
            const issue_number = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let body = `${{ steps.appcat-test.outputs.msg }}`;
            
            // If body is empty, set a default message
            if (!body || body.trim() === '') {
              body = 'Appcat test completed. Check the workflow logs for details.';
            }

            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number
            });

            const botComment = comments.data.find(comment => 
              comment.user.login === 'github-actions[bot]');
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}
          debug: true

      - name: Update tests badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tests-rate
          LABEL: Test Status
          STATUS: ${{ steps.appcat-test.outputs.tests_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update test case badge
        if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        uses: RubbaBoy/BYOB@v1.3.0
        with:
          NAME: konveyor-rulesets-tcs-rate
          LABEL: Test Case Status
          STATUS: ${{ steps.appcat-test.outputs.tcs_pass_rate }}
          COLOR: blue
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check test result
        if: ${{ steps.appcat-test.outcome == 'failure' }}
        run: exit 1