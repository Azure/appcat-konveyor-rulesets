- category: mandatory
  customVariables: []
  description: Avoid File System Logging in Java Code
  effort: 1
  labels:
  - source
  - target=azure-aks
  - target=azure-container-apps
  - target=azure-appservice
  - domain=cloud-readiness
  - category=logging-management
  - logging
  - os=windows
  - os=linux
  links:
  - title: Workspace-based Application Insights
    url: https://learn.microsoft.com/azure/azure-monitor/app/create-workspace-resource
  - title: Diagnostic settings
    url: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings
  message: |-
    Detected usage of Java APIs that write logs to the local file system. In Azure PaaS and container environments, file-based logging is discouraged because the file system is ephemeral and logs cannot be reliably aggregated across instances.

    Recommendations:
    * Prefer console logging: Configure Logback / Log4j / JUL to write logs to stdout/stderr only.
    * Use Azure Monitor Logs: Capture console output via Azure platform diagnostic settings into workspace-based Application Insights (Log Analytics).
    * Emit structured JSON logs to enable richer querying, aggregation, and correlation using KQL.
    * Centralize analysis and visualization using Azure Monitor (Log Analytics).
  ruleID: logging-0000
  when:
    or:
    - java.referenced:
        location: IMPORT
        pattern: org.apache.*log4j.*FileAppender*
    - java.referenced:
        location: IMPORT
        pattern: java.util.logging.FileHandler*
    - java.referenced:
        location: IMPORT
        pattern: ch.qos.logback.core.FileAppender
    - java.referenced:
        location: IMPORT
        pattern: org.pmw.tinylog.writers.FileWriter
- category: mandatory
  customVariables: []
  description: Logging to Socket Handler
  effort: 3
  labels:
  - source
  - target=azure-aks
  - target=azure-container-apps
  - target=azure-appservice
  - domain=cloud-readiness
  - category=logging-management
  - logging
  - os=windows
  - os=linux
  links:
  - title: Diagnostic settings
    url: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings
  message: |-
    Detected usage of `java.util.logging.SocketHandler`. Host-bound socket logging is not cloud-friendly due to fixed endpoints, firewall constraints, and fragile network dependencies in dynamic cloud environments.

    Recommendations:
    * Log to console (stdout/stderr) and let Azure capture logs via diagnostic settings.
    * Use Azure Monitor Logs (workspace-based Application Insights) for centralized collection and querying.
    * Prefer structured JSON output for improved search, aggregation, and correlation.
  ruleID: logging-0001
  when:
    java.referenced:
      location: IMPORT
      pattern: java.util.logging.SocketHandler*
- category: mandatory
  customVariables: []
  description: Avoid File System Logging in Configuration
  effort: 1
  labels:
  - source
  - target=azure-aks
  - target=azure-container-apps
  - target=azure-appservice
  - domain=cloud-readiness
  - category=logging-management
  - logging
  - os=windows
  - os=linux
  links:
  - title: Azure Monitor Logs overview
    url: https://learn.microsoft.com/azure/azure-monitor/logs/data-platform-logs
  - title: Log queries in Azure Monitor
    url: https://learn.microsoft.com/azure/azure-monitor/logs/log-query-overview
  - title: Enable diagnostics logging for apps in Azure App Service
    url: https://learn.microsoft.com/azure/app-service/troubleshoot-diagnostic-logs
  - title: Log Analytics tutorial
    url: https://learn.microsoft.com/azure/azure-monitor/logs/log-analytics-tutorial
  - title: Workspace-based Application Insights
    url: https://learn.microsoft.com/azure/azure-monitor/app/create-workspace-resource
  - title: Diagnostic settings
    url: https://learn.microsoft.com/azure/azure-monitor/essentials/diagnostic-settings
  message: |-
    Detected a logging configuration that writes logs to the local file system. In Azure environments, file-based appenders are discouraged due to ephemeral storage and lack of centralized access.

    Recommendations:
    * Switch to console appenders only (Logback / Log4j) and disable file or rolling file appenders.
    * Collect logs using Azure Monitor Logs (workspace-based Application Insights) via diagnostic settings.
    * Output structured JSON logs to improve KQL querying and cross-service correlation.
  ruleID: logging-0002
  when:
    or:
    # log4j 1.x: FileAppender, RollingFileAppender, DailyRollingFileAppender
    # log4j 2.x: File, RandomAccessFile, MemoryMappedFile, RollingFile, RollingRandomAccessFile
    # https://logging.apache.org/log4j/2.x/manual/appenders.html#file-appenders
    - builtin.filecontent:
        filePattern: log(?:back|4j)([a-zA-Z0-9._-]*)\.(xml|properties)$
        pattern: (?i)\b(?:Daily)?(?:Rolling)?(?:RandomAccess)?(?:MemoryMapped)?File(?:Appender)?\b
- category: potential
  customVariables: []
  description: Embedded library - Logstash
  effort: 3
  labels:
  - source
  - target=azure-aks
  - target=azure-container-apps
  - target=azure-appservice
  - domain=cloud-readiness
  - category=logging-management
  - logging
  - os=windows
  - os=linux
  links:
  - title: Ensure console logging and configure diagnostic settings
    url: https://learn.microsoft.com/en-us/azure/developer/java/migration/migrate-spring-boot-to-azure-container-apps#ensure-console-logging-and-configure-diagnostic-settings
  - title: Azure Event Hub
    url: https://learn.microsoft.com/azure/event-hubs/event-hubs-about
  - title: Logstash EventHub plugin
    url: https://github.com/logstash-plugins/logstash-input-azure_event_hubs
  message: |-
    The application embeds the Logstash framework. In Azure, managing in-application Logstash pipelines is often unnecessary and increases operational complexity compared to Azure-native log collection.

    Recommendations:
    * Emit logs to console (stdout/stderr) and avoid file-based appenders.
    * Use Azure Monitor Logs (workspace-based Application Insights) for log collection, retention, and querying.
    * Produce structured JSON logs for improved analysis and correlation.
    * If an existing ELK stack must be retained, stream Azure-collected logs to Event Hubs via diagnostic settings and ingest them using the Logstash Event Hubs input plugin.
  ruleID: logging-0003
  when:
    or:
    - java.dependency:
        name: org.logstash.logstash-core
    - builtin.file:
        pattern: ^([a-zA-Z0-9._-]*)logstash([a-zA-Z0-9._-]*)\.jar$
- category: potential
  customVariables: []
  description: Embedded library - Splunk
  effort: 3
  labels:
  - source
  - target=azure-aks
  - target=azure-container-apps
  - target=azure-appservice
  - domain=cloud-readiness
  - category=logging-management
  - logging
  - os=windows
  - os=linux
  links:
  - title: Ensure console logging and configure diagnostic settings
    url: https://learn.microsoft.com/en-us/azure/developer/java/migration/migrate-spring-boot-to-azure-container-apps#ensure-console-logging-and-configure-diagnostic-settings
  - title: Azure Blob Storage
    url: https://learn.microsoft.com/azure/storage/blobs/
  - title: Splunk Add-on for Microsoft Cloud Services
    url: https://splunkbase.splunk.com/app/3757
  - title: Azure Event Hub
    url: https://learn.microsoft.com/azure/event-hubs/event-hubs-about
  message: |-
    The application embeds Splunk-related libraries. In Azure, directly shipping logs from the application to Splunk is generally discouraged in favor of platform-level log collection.

    Recommendations:
    * Write logs to console (stdout/stderr) and let Azure platform diagnostic settings collect them.
    * Prefer Azure Monitor Logs (workspace-based Application Insights) for centralized collection and analysis.
    * Emit structured JSON logs for richer querying and correlation.
    * If Splunk is required, forward Azure-collected logs via Event Hubs or Blob Storage and ingest them using the Splunk Add-on for Microsoft Cloud Services.
  ruleID: logging-0004
  when:
    or:
    - java.dependency:
        nameregex: ([a-zA-Z0-9._-]*)splunk([a-zA-Z0-9._-]*)
    - builtin.file:
        pattern: ^([a-zA-Z0-9._-]*)splunk([a-zA-Z0-9._-]*)\.jar$
- category: potential
  customVariables: []
  description: Embedded framework - Zipkin
  effort: 1
  labels:
  - source
  - target=azure-aks
  - target=azure-container-apps
  - target=azure-appservice
  - domain=cloud-readiness
  - category=logging-management
  - logging
  - os=windows
  - os=linux
  links:
  - title: Azure Monitor
    url: https://learn.microsoft.com/azure/azure-monitor/
  - title: Observability in Azure Container Apps
    url: https://learn.microsoft.com/en-us/azure/container-apps/observability
  - title: Distributed Tracing
    url: https://learn.microsoft.com/azure/azure-monitor/app/distributed-trace-data
  - title: Enable OpenTelemetry for Azure Monitor
    url: https://learn.microsoft.com/azure/azure-monitor/app/opentelemetry-enable
  message: |-
    The application embeds the Zipkin framework for distributed tracing. In Azure, Azure Monitor (workspace-based Application Insights) with OpenTelemetry is the preferred approach for end-to-end observability.

    Recommendations:
    * Evaluate removing or phasing out Zipkin dependencies where feasible.
    * Adopt the OpenTelemetry SDK or agent with the Azure Monitor exporter; many Azure services support auto-instrumentation.
    * Use W3C Trace Context and emit structured JSON logs to improve correlation across traces, logs, and metrics in Azure Monitor Logs.
  ruleID: logging-0005
  when:
    or:
    - java.dependency:
        name: org.springframework.boot.spring-cloud-starter-zipkin
    - java.dependency:
        nameregex: io\.zipkin([a-zA-Z0-9._-]*)
    - builtin.file:
        pattern: ^([a-zA-Z0-9._-]*)zipkin([a-zA-Z0-9._-]*)\.jar$
