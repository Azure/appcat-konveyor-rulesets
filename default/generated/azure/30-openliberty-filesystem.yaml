- category: mandatory
  description: Detect OpenLiberty Server File Path Configurations
  effort: 3
  labels:
  - konveyor.io/source=java-ee
  - konveyor.io/target=aks
  message: |
    Detected file path configurations in OpenLiberty server that need to be migrated to Azure storage solutions.
    
    **Migration Steps:**
    - Replace local file paths with Azure Storage solutions (Blob Storage, File Share, Disk)
    - For transient storage, use emptyDir volume in Kubernetes pods
    - For persistent storage, use Azure Files or Azure Managed Disks as PersistentVolumes
    - For shared content, use Azure Blob Storage with appropriate SDKs
    
    Example configuration in Kubernetes:
    ```yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: azure-files-pvc
    spec:
      accessModes:
        - ReadWriteMany
      storageClassName: azurefile
      resources:
        requests:
          storage: 10Gi
    ```
    
    Kubernetes deployment:
    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    spec:
      template:
        spec:
          containers:
          - name: app
            volumeMounts:
            - name: storage
              mountPath: /mnt/data
          volumes:
          - name: storage
            persistentVolumeClaim:
              claimName: azure-files-pvc
    ```
  ruleID: aks-liberty-filesystem-00060
  when:
    builtin.xml:
      filepaths:
      - server.xml
      namespaces: {}
      xpath: //*[@dir] | //*[@directory] | //*[@path] | //*[@location][not(contains(@location, '.war') or contains(@location, '.ear') or contains(@location, '.jar'))]

- category: mandatory
  description: Detect Web.xml File Path Environment Entries
  effort: 3
  labels:
  - konveyor.io/source=java-ee
  - konveyor.io/target=aks
  message: |
    Detected environment entries in web.xml defining file paths that need to be updated for Azure storage solutions.
    
    **Migration Recommendations:**
    - Use Kubernetes ConfigMaps or Secrets to externalize path configurations
    - Reference Azure storage endpoints instead of local file paths
    - Mount Azure storage solutions to container paths through Kubernetes volumes
    
    Example of ConfigMap for file paths:
    ```yaml
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: storage-paths
    data:
      uploadPath: "/mnt/azurefiles/uploads"
      tempPath: "/mnt/azurefiles/temp"
    ```
    
    Inject through environment variables:
    ```yaml
    env:
    - name: UPLOAD_PATH
      valueFrom:
        configMapKeyRef:
          name: storage-paths
          key: uploadPath
    ```
  ruleID: aks-webapp-filepath-env-00061
  # when:
  #   or:
  #   - builtin.xml:
  #       filepaths:
  #       - web.xml
  #       namespaces:
  #         jee: http://xmlns.jcp.org/xml/ns/javaee
  #         xpath: //jee:env-entry[jee:env-entry-name[contains(lower-case(text()), 'path') or contains(lower-case(text()), 'dir') or contains(lower-case(text()), 'folder') or contains(lower-case(text()), 'file')]]
  #   - builtin.xml:
  #       filepaths:
  #       - web.xml
  #       namespaces:
  #         j2ee: http://java.sun.com/xml/ns/j2ee
  #       xpath: //j2ee:env-entry[j2ee:env-entry-name[contains(lower-case(text()), 'path') or contains(lower-case(text()), 'dir') or contains(lower-case(text()), 'folder') or contains(lower-case(text()), 'file')]]
  #   - builtin.xml:
  #       filepaths:
  #       - web.xml
  #       namespaces:
  #         jakarta: https://jakarta.ee/xml/ns/jakartaee
  #       xpath: //jakarta:env-entry[jakarta:env-entry-name[contains(lower-case(text()), 'path') or contains(lower-case(text()), 'dir') or contains(lower-case(text()), 'folder') or contains(lower-case(text()), 'file')]]
  when:
    or:
    - builtin.xml:
        filepaths:
        - web.xml
        namespaces:
          jee: http://xmlns.jcp.org/xml/ns/javaee
        xpath: //jee:env-entry[jee:env-entry-name[contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'path') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'dir') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'folder') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'file')]]
    - builtin.xml:
        filepaths:
        - web.xml
        namespaces:
          j2ee: http://java.sun.com/xml/ns/j2ee
        xpath: //j2ee:env-entry[j2ee:env-entry-name[contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'path') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'dir') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'folder') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'file')]]
    - builtin.xml:
        filepaths:
        - web.xml
        namespaces:
          jakarta: https://jakarta.ee/xml/ns/jakartaee
        xpath: //jakarta:env-entry[jakarta:env-entry-name[contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'path') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'dir') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'folder') or contains(translate(text(), 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', 'abcdefghijklmnopqrstuvwxyz'), 'file')]]

- category: mandatory
  description: Detect File Path Resource Injections
  effort: 3
  labels:
  - konveyor.io/source=java-ee
  - konveyor.io/target=aks
  message: |
    Detected @Resource annotations for file path injections that need to be updated for Azure storage.
    
    **Migration Recommendations:**
    - Replace direct file path injections with Azure Storage SDK clients
    - Configure application to use mounted Azure storage paths in Kubernetes
    - Consider using Azure Blob Storage client for file-like operations
    
    Example code update:
    ```java
    // Before:
    @Resource(name = "uploadPath")
    private String uploadDir;
    
    // After:
    @Value("${UPLOAD_PATH}")
    private String uploadPath;
    
    // Or with Azure Blob Storage SDK:
    @Autowired
    private BlobServiceClient blobServiceClient;
    ```
  ruleID: aks-file-resource-injection-00062
  when:
    or:
    - java.referenced:
        location: ANNOTATION
        pattern: javax.annotation.Resource
        annotated:
          elements:
            - name: name
              value: ".*(?i)(path|dir|directory|folder|file|store|upload|download|temp|cache|log|data|config).*"
    - java.referenced:
        location: ANNOTATION
        pattern: jakarta.annotation.Resource
        annotated:
          elements:
            - name: name
              value: ".*(?i)(path|dir|directory|folder|file|store|upload|download|temp|cache|log|data|config).*" 

- category: mandatory
  description: Detect ServletContext Path Usage
  effort: 3
  labels:
  - konveyor.io/source=java-ee
  - konveyor.io/target=aks
  message: |
    Detected usage of ServletContext.getRealPath() which needs to be reconsidered in containerized environments.
    
    **Migration Considerations:**
    - ServletContext.getRealPath() might not work as expected in containerized environments
    - Use resource streaming for files packaged within the application
    - For external files, use Azure Blob Storage or mounted Azure Files
    
    Example refactoring:
    ```java
    // Before:
    String path = getServletContext().getRealPath("/WEB-INF/uploads");
    File file = new File(path, "example.txt");
    
    // After (resource streaming):
    InputStream is = getServletContext().getResourceAsStream("/WEB-INF/uploads/example.txt");
    
    // Or for external storage:
    BlobClient blobClient = containerClient.getBlobClient("example.txt");
    ```
  ruleID: aks-servlet-realpath-00064
  when:
    or:
    - java.referenced:
        location: METHOD_CALL
        pattern: javax.servlet.ServletContext.getRealPath
    - java.referenced:
        location: METHOD_CALL
        pattern: jakarta.servlet.ServletContext.getRealPath

# - category: mandatory
#   description: Detect System Properties for File Paths
#   effort: 3
#   labels:
#   - konveyor.io/source=java-ee
#   - konveyor.io/target=aks
#   message: |
#     Detected usage of System Properties for file paths which need to be updated for cloud environments.
    
#     **Migration Recommendations:**
#     - Replace System Properties with environment variables or ConfigMaps
#     - Use Kubernetes environment variables to inject storage paths
#     - Consider Azure Storage SDKs for file operations instead of direct file system access
    
#     Example code update:
#     ```java
#     // Before:
#     String uploadDir = System.getProperty("app.upload.dir", "/tmp/default");
    
#     // After (environment variable):
#     String uploadDir = System.getenv().getOrDefault("UPLOAD_PATH", "/mnt/azurefiles/uploads");
    
#     // Or with Spring Boot:
#     @Value("${upload.path:/mnt/azurefiles/uploads}")
#     private String uploadDir;
#     ```
#   ruleID: aks-system-properties-file-00065
#   when:
#     java.referenced:
#       pattern: "System.getProperty"
#       referencedBy:
#         pattern: ".*(path|dir|directory|folder|file).*"
